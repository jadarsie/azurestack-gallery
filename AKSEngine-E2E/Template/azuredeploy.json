{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "linuxAdminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "User name for the Linux Virtual Machines that are part of the Kubernetes cluster and DVM."
      }
    },
    "sshPublicKey": {
      "metadata": {
        "description": "SSH public key used for auth to all Linux machines created as part of the the Kubernetes cluster and DVM."
      },
      "type": "string"
    },
    "masterProfileDnsPrefix": {
      "type": "string",
      "metadata": {
        "description": "This must be a region-unique name e.g. k8s-12345. Try to chose it same as the resource group name as best practice."
      }
    },
    "agentPoolProfileCount": {
      "defaultValue": 3,
      "metadata": {
        "description": "Kubernetes Node Pool Profile Count"
      },
      "type": "int"
    },
    "agentPoolProfileVMSize": {
      "defaultValue": "Standard_D2_v2",
      "metadata": {
        "description": "The VMSize of Kubernetes node VMs"
      },
      "type": "string"
    },
    "masterPoolProfileCount": {
      "defaultValue": 3,
      "metadata": {
        "description": "Kubernetes Master Pool Profile Count"
      },
      "type": "int"
    },
    "masterPoolProfileVMSize": {
      "defaultValue": "Standard_D2_v2",
      "metadata": {
        "description": "The VMSize of Kubernetes master VMs"
      },
      "type": "string"
    },
    "storageProfile": {
      "defaultValue": "manageddisk",
      "metadata": {
        "description": "The Storage Profile"
      },
      "type": "string"
    },
    "servicePrincipalClientId": {
      "metadata": {
        "description": "The Service Principal application ID (used by the Kubernetes Azure cloud provider). More help here: https://github.com/Azure/aks-engine/blob/master/docs/topics/service-principals.md"
      },
      "type": "securestring"
    },
    "servicePrincipalClientSecret": {
      "metadata": {
        "description": "The Service Principal Client Secret."
      },
      "type": "securestring"
    },
    "identitySystem": {
      "defaultValue": "AzureAD",
      "allowedValues": [
        "AzureAD",
        "ADFS"
      ],
      "metadata": {
        "description": "The identity system of azure stack. The value could be AzureAD or ADFS"
      },
      "type": "string"
    },
    "aksEngineNodeCount": {
      "defaultValue": 5,
      "metadata": {
        "description": "The aks engine scale node count"
      },
      "type": "int"
    },
    "aksEngineUpgradeVersion": {
      "metadata": {
        "description": "The kubernetes upgrade version using aks engine"
      },
      "type": "string"
    },
    "aksEngineApiModel": {
      "defaultValue": "https://raw.githubusercontent.com/honcao/aks-engine/e2e/examples/kubernetes-azure-stack.json",
      "metadata": {
        "description": "The API Model to be used for kubernetes deployment using aks engine "
      },
      "type": "string"
    },
    "aksEngineRepository": {
      "metadata": {
        "description": "The Aks Engine Repository to be used for building aks engine binary"
      },
      "type": "string"
    },
    "aksEngineBranch": {
      "metadata": {
        "description": "The Aks Engine branch to be used for building the aks engine binary"
      },
      "type": "string"
    },
    "networkPlugin": {
      "defaultValue": "flannel",
      "allowedValues": [
        "flannel",
        "azure",
        "kubenet"
      ],
      "metadata": {
        "description": "Network plugin which will deployed in Kubernetes cluster"
      },
      "type": "string"
    },
    "availabilityProfile": {
      "defaultValue": "AvailabilitySet",
      "allowedValues": [
        "AvailabilitySet",
        "VirtualMachineScaleSets"
      ],
      "metadata": {
        "description": "Availability profile that nodes in the Kubernetes cluster will be deployed with"
      },
      "type": "string"
    },
    "windowsAgentPoolProfileCount": {
      "defaultValue": "0",
      "metadata": {
        "description": "Kubernetes Windows node pool profile count"
      },
      "type": "string"
    },
    "windowsAgentPoolProfileVMSize": {
      "defaultValue": "Standard_D2_v2",
      "metadata": {
        "description": "The virtual machine size of the Kubernetes Windows agent nodes"
      },
      "type": "string"
    },
    "windowsAdminUsername": {
      "defaultValue": "azureuser",
      "metadata": {
        "description": "User name for the Windows virtual machines that are part of the Kubernetes cluster."
      },
      "type": "string"
    },
    "windowsAdminPassword": {
      "defaultValue": "",
      "metadata": {
        "description": "Password for the Windows virtual machines that are part of the Kubernetes cluster."
      },
      "type": "securestring"
    },
    "kubernetesAzureCloudProviderVersion": {
      "type": "string",
      "defaultValue": "1.11",
      "metadata": {
        "description": "This is the version for the Kubernetes Azure cloud provider. We would use a custom Kubernetes build specifically for Azure Stack for each version."
      }
    }
  },
  "variables": {
    "resourceGroupName": "[resourceGroup().name]",
    "dnsNameForPublicIP": "[toLower(concat('vmd-dns', parameters('masterProfileDnsPrefix')))]",
    "location": "[resourceGroup().location]",
    "imagePublisher": "Canonical",
    "imageOffer": "UbuntuServer",
    "imageSku": "16.04-LTS",
    "imageVersion": "latest",
    "vmSize": "Standard_D2_v2",
    "OSDiskName": "osdisk",
    "nicName": "[concat('vmd-vnic', uniqueString(resourceGroup().id))]",
    "addressPrefix": "10.0.0.0/24",
    "subnetName": "mySubnet",
    "subnetPrefix": "10.0.0.0/24",
    "storageAccountName": "[concat('vmdsa', uniquestring(resourceGroup().id))]",
    "storageAccountType": "Standard_LRS",
    "publicIPAddressName": "[concat('vmd-publicIP', uniqueString(resourceGroup().id))]",
    "publicIPAddressType": "Static",
    "vmStorageAccountContainerName": "vhds",
    "vmName": "[concat('vmd-', uniqueString(resourceGroup().id))]",
    "virtualNetworkName": "[concat('vmd-vnet-', uniqueString(resourceGroup().id))]",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]",
    "networkSecurityGroupName": "[tolower(concat('vmd-nsg',uniquestring(resourceGroup().id)))]",
    "sshKeyPath": "[concat('/home/',parameters('linuxAdminUsername'),'/.ssh/authorized_keys')]",
    "tenantSubscriptionId": "[subscription().subscriptionId]",
    "scriptName": "script",
    "singleQuote": "'",
    "scriptParameters": "[concat('IDENTITY_SYSTEM=','\"',parameters('identitySystem'),'\"',' WINDOWS_AGENT_COUNT=','\"',parameters('windowsAgentPoolProfileCount'),'\"' ,' WINDOWS_AGENT_SIZE=','\"',parameters('windowsAgentPoolProfileVMSize'),'\"',' WINDOWS_ADMIN_USERNAME=','\"',parameters('windowsAdminUsername'),'\"',' WINDOWS_ADMIN_PASSWORD=','\"',parameters('windowsAdminPassword'),'\"',' NETWORK_PLUGIN=','\"',parameters('networkPlugin'),'\"',' AVAILABILITY_PROFILE=','\"',parameters('availabilityProfile'),'\"',' RESOURCE_GROUP_NAME=','\"',variables('resourceGroupName'),'\"',' PUBLICIP_DNS=','\"',variables('dnsNameForPublicIP'),'\"' ,' TENANT_ID=','\"',subscription().tenantId,'\"' ,' TENANT_SUBSCRIPTION_ID=','\"',variables('tenantSubscriptionId'),'\"',' ADMIN_USERNAME=','\"',parameters('linuxAdminUsername'),'\"',' MASTER_DNS_PREFIX=','\"',parameters('masterProfileDnsPrefix'),'\"' ,' AGENT_COUNT=','\"',parameters('agentPoolProfileCount'),'\"' ,' AGENT_SIZE=','\"',parameters('agentPoolProfileVMSize'),'\"' ,' MASTER_COUNT=','\"',parameters('masterPoolProfileCount'),'\"',' MASTER_SIZE=','\"',parameters('masterPoolProfileVMSize'),'\"' ,' SPN_CLIENT_ID=','\"',parameters('servicePrincipalClientId'),'\"' ,' SPN_CLIENT_SECRET=','\"',parameters('servicePrincipalClientSecret'),'\"' ,' K8S_AZURE_CLOUDPROVIDER_VERSION=','\"',parameters('kubernetesAzureCloudProviderVersion'),'\"' ,' REGION_NAME=','\"',variables('location'),'\"' ,' SSH_PUBLICKEY=','\"',parameters('sshPublicKey'),'\"' ,' STORAGE_PROFILE=','\"',parameters('storageProfile'),'\"',' AKSENGINE_NODE_COUNT=','\"',parameters('aksEngineNodeCount'),'\"',' AKSENGINE_UPGRADE_VERSION=','\"',parameters('aksEngineUpgradeVersion'),'\"',' AKSENGINE_API_MODEL=','\"',parameters('aksEngineApiModel'),'\"',' AKSENGINE_REPO=','\"',parameters('aksEngineRepository'),'\"',' AKSENGINE_BRANCH=','\"',parameters('aksEngineBranch'),'\"')]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[toLower(variables('storageAccountName'))]",
      "apiVersion": "2015-06-15",
      "location": "[variables('location')]",
      "properties": {
        "accountType": "[variables('storageAccountType')]"
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('networkSecurityGroupName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
            "name": "ssh",
            "properties": {
              "description": "Allow SSH",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 200,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[variables('location')]",
      "properties": {
        "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
        "dnsSettings": {
          "domainNameLabel": "[variables('dnsNameForPublicIP')]"
        }
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('virtualNetworkName')]",
      "location": "[variables('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('addressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "[variables('subnetPrefix')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]",
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
        "[variables('networkSecurityGroupName')]"
      ],
      "properties": {
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
        },
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2016-03-30",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "customData": "[base64(concat('#cloud-config\n\nwrite_files:\n- path: /opt/azure/containers/script.sh\n  permissions: \"0744\"\n  encoding: gzip\n  owner: root:root\n  content: !!binary |\n    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'))]",
          "computerName": "[variables('vmName')]",
          "adminUsername": "[parameters('linuxAdminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": "true",
            "ssh": {
              "publicKeys": [
                {
                  "keyData": "[parameters('sshPublicKey')]",
                  "path": "[variables('sshKeyPath')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[variables('imagePublisher')]",
            "offer": "[variables('imageOffer')]",
            "sku": "[variables('imageSku')]",
            "version": "[variables('imageVersion')]"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob, variables('vmStorageAccountContainerName'),'/',variables('OSDiskName'),'.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": "true",
            "storageUri": "[reference(concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/LinuxCustomScriptExtension')]",
      "apiVersion": "2016-03-30",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]",
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.0",
        "autoUpgradeMinorVersion": "true",
        "protectedSettings": {
          "commandToExecute": "[concat(variables('scriptParameters'), ' PUBLICIP_FQDN=', '\"', reference(resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName')),'2015-06-15').dnsSettings.fqdn,'\"',' /bin/bash /opt/azure/containers/script.sh >> /var/log/azure/deploy-script-dvm.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "dvmPublicIpFqdn": {
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName')),'2015-06-15').dnsSettings.fqdn]",
      "type": "string"
    }
  }
}
